## 项目总结

### 使用技术

1. 工程化技术选型
   1. 代码风格和格式化:：使用ESLint和Prettier用于统一代码风格
   2. 前端项目构建：使用Vite进行构建和开发
   3. 类型声明：使用typescript进行类型检查，提高可读性，可维护性
   4. 代码版本管理：使用 Git 进行代码版本管理，结合commitlint和husky等对提交进行规范


2. 功能技术选型
   1. 前端框架Vue3，使用D3用于绘制依赖关系图
   2. 服务器框架koa用于构建后端服务，提供API将依赖数据吐出给前端
   3. 服务器commander node命令行解决方案，inquirer: 命令行交互工具
   4. 服务器提供递归node_modules和扫描locak file两种方式实现构建依赖关系


### 系统关键设计说明

1. 递归node_modules构建依赖关系
   1. 类：DependencyGraphBuilder类负责构建依赖关系图，提供公共getGraphData方法获取依赖包及依赖项图形数据
   2. 方法：getGraphData处理查询、包和深度参数，调用buildGraph递归构建依赖关系，其中checkFile方法用于检查指定路径的文件状态
   3. 数据：构建图形数据时处理依赖关系、节点类型计算、关键字，通过记录已访问的依赖避免循环依赖，同时对异步操作进行异常处理以确保程序可靠
   4. 错误：处理文件不存在、路径错误、JSON解析错误等异常
   5. 性能：控制递归深度以避免堆栈溢出、去重处理以确保数据节点和边的唯一性
2. 扫描lock file构建依赖关系
   1. 抽象基类：baseDepGraph是抽象基类，定义parse方法用于解析锁文件并生成依赖关系
   2. 解析锁文件：parse方法根据不同的锁文件类型（pnpm、npm、yarn）使用不同解析方法并生成依赖关系
   3. 返回依赖关系数据，graph表示边，nodeArray表示节点
3. d3渲染依赖关系图
   1. 数据转换：将接收到的graph和nodeArray通过convertData函数转换成links和nodes数组
   2. 渲染图标：renderChart函数创建d3图表。创建一个SVG容器并设置尺寸和缩放行为，使用selectAll方法选择链接和节点并绑定到选择的元素，最后使用attr方法设置链接和节点属性并添加鼠标事件
4. 命令行cli和交互
   1. 参数配置：使用Reflect.ownKeys循环创建命令mapActions
   2. 交互：使用inquirer进行命令行交互，提示用户选择
   3. 版本号管理：通过readVersion方法动态获取版本号
   4. 帮助信息：监听program对象--help事件

### 关键流程图

![依赖分析](https://p.ipic.vip/6v6let.jpg)

### 过程中遇到什么问题

1. 如何有效地管理和标识项目的依赖关系，特别是处理循环依赖和重复依赖
   1. 实现了visited集合来跟踪已访问的依赖项
   2. removeDuplicates方法去除图中已经存在的重复节点和边
2. 递归深度控制：可能导致性能问题或无限循环、堆栈溢出
   1. 明确递归深度上限，如果用户有传参数直接使用，否则默认设置2
   2. 并在递归调用时递增深度计数器
3. 循环依赖：两个或多个包互相依赖，可能导致死循环或错误数据展示
   1. 记录已访问的依赖项，在递归调用前检查是否已经访问过避免循环依赖
4. 文件路径处理：读取依赖包文件可能路径错误或文件不存在导致构建异常
   1. 读取依赖包文件时确保路径正确性，处理失败情况，使用fs/promises检查文件状态和读取内容
5. 异常处理：读取文件、JSON解析错误等
   1. 异常操作适当处理异常，使用try-catch捕获
6. 确保程序能够正确处理不同包管理器的锁文件，以及在文件系统中准确定位到依赖包的路径
   1. processLockFile 函数会根据不同的锁文件类型选择相应的类来处理锁文件
   2. 定义抽象类baseDepGraph并定义抽象方法parse，不同类型锁文件继承它实现自己的parse方法以解析特定包管理器生成的锁文件数据
7. D3如何根据层级渲染颜色，如何实现缩放，如何显示节点关联数据，如何定位到节点和连线并实现相关的拖拽、显示信息等
   1. 渲染颜色使用d3.scaleOrdinal根据group渲染颜色，它是包含10种颜色的调色板
   2. 缩放通过d3.zoom() 方法实现，其中scaleExtent设置缩放范围
   3. 当鼠标移动到节点或连接线上时，在handleMouseOver和handleMouseOut函数中会设置节点和连接线的透明度以实现节点相关联的数据，还会显示相关数据，创建一个tooltip并设置其位置、内容等
   4. 拖拽通过d3拖动功能实现，定义drag实现拖拽的开始、中间和结束状态，在dragstarted、dragged、dragended函数中设置节点的固定位置以及重启和停止模拟
   5. 交互性方面自定义实现了较多功能，如缩放、拖拽、节点连接线信息自定义显示、多层级颜色渲染、节点相关数据高亮、连接线来源去向数据展示等
8. 命令行参数解析输入不存在命令
   1. 程序无法正确处理，增加command not found错误处理
